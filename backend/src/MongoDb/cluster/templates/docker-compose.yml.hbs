version: '3.4'

services:
  {{#each config_servers}}
  {{this}}:
    image: ${DOCKER_REGISTRY-}pekalam/{{this}}
    hostname: {{this}}
    build:
      dockerfile: config/Dockerfile
      context: .
    command: ["--configsvr", "--replSet", "configRS", "--bind_ip_all", "--keyFile", "/data/mongocluster-keyfile"]
    volumes:
      - {{this}}_data:/data/db
      - {{this}}_config:/data/configdb
    secrets:
      - mongocluster-keyfile 
    depends_on:
  {{/each}}
  {{#each nodes}}
      - {{this}}
  {{/each}}
  {{#each mongos}}
  {{this}}:
    image: ${DOCKER_REGISTRY-}pekalam/{{this}}
    hostname: {{this}}
    build:
      dockerfile: mongos/Dockerfile
      context: .
    command: ["--wait-for", {{#each ../config_servers}}"{{this}}:32112"{{#if @last}}{{else}}, {{/if}}{{/each}}, {{#each ../nodes}}"{{this}}:32112"{{#if @last}}{{else}}, {{/if}}{{/each}}, "--configdb", "configRS/{{#each ../config_servers}}{{this}}:27019{{#if @last}}{{else}}, {{/if}}{{/each}}", "--bind_ip_all", "--keyFile=/data/mongocluster-keyfile"]
    ports:
      {{#if @first}}
      - "27017:27017"       
      {{/if}}
    volumes:
      - {{this}}_mongos_data:/data/db
      - {{this}}_mongos_config:/data/configdb
    secrets:
      - mongocluster-keyfile 
  {{/each}}
  {{#each nodes}}
  {{this}}:
    image: ${DOCKER_REGISTRY-}pekalam/{{this}}
    hostname: {{this}}
    build:
      dockerfile: shards/shard_{{this}}/Dockerfile
      context: .
    command: [ "--bind_ip_all", "--replSet", "n{{inc @index}}", "--shardsvr", "--keyFile=/data/mongocluster-keyfile" ]
    volumes:
      - {{this}}_data:/data/db
      - {{this}}_config:/data/configdb
    secrets:
      - mongocluster-keyfile 
  {{/each}}


volumes:
{{#each config_servers}}
  {{this}}_data:
  {{this}}_config:
{{/each}}
{{#each nodes}}
  {{this}}_data:
  {{this}}_config:
{{/each}}
{{#each mongos}}
  {{this}}_mongos_data:
  {{this}}_mongos_config:
{{/each}}

secrets:
  mongocluster-keyfile:
    external: true